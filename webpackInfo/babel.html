<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AST、Babel、依赖 | blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="系统性学习，打造完善的知识体系">
    
    <link rel="preload" href="/interview_blog/assets/css/0.styles.81bffcaa.css" as="style"><link rel="preload" href="/interview_blog/assets/js/app.6e789ca6.js" as="script"><link rel="preload" href="/interview_blog/assets/js/2.aedcd1eb.js" as="script"><link rel="preload" href="/interview_blog/assets/js/44.d134aed1.js" as="script"><link rel="prefetch" href="/interview_blog/assets/js/10.235d3cd2.js"><link rel="prefetch" href="/interview_blog/assets/js/11.64c88d1d.js"><link rel="prefetch" href="/interview_blog/assets/js/12.389e02a9.js"><link rel="prefetch" href="/interview_blog/assets/js/13.5fd0b99f.js"><link rel="prefetch" href="/interview_blog/assets/js/14.addbf244.js"><link rel="prefetch" href="/interview_blog/assets/js/15.aaa172ef.js"><link rel="prefetch" href="/interview_blog/assets/js/16.efde6c27.js"><link rel="prefetch" href="/interview_blog/assets/js/17.efe499ad.js"><link rel="prefetch" href="/interview_blog/assets/js/18.b43e2679.js"><link rel="prefetch" href="/interview_blog/assets/js/19.1e7d1f1d.js"><link rel="prefetch" href="/interview_blog/assets/js/20.61100763.js"><link rel="prefetch" href="/interview_blog/assets/js/21.77d90c63.js"><link rel="prefetch" href="/interview_blog/assets/js/22.f398ec5f.js"><link rel="prefetch" href="/interview_blog/assets/js/23.a0ed082a.js"><link rel="prefetch" href="/interview_blog/assets/js/24.a5e14725.js"><link rel="prefetch" href="/interview_blog/assets/js/25.dbe614ed.js"><link rel="prefetch" href="/interview_blog/assets/js/26.f2947465.js"><link rel="prefetch" href="/interview_blog/assets/js/27.ccd771c7.js"><link rel="prefetch" href="/interview_blog/assets/js/28.78bc3610.js"><link rel="prefetch" href="/interview_blog/assets/js/29.ad03d3fc.js"><link rel="prefetch" href="/interview_blog/assets/js/3.b709dd0d.js"><link rel="prefetch" href="/interview_blog/assets/js/30.12e12cb8.js"><link rel="prefetch" href="/interview_blog/assets/js/31.63b1cf5c.js"><link rel="prefetch" href="/interview_blog/assets/js/32.10ace32c.js"><link rel="prefetch" href="/interview_blog/assets/js/33.14d149d9.js"><link rel="prefetch" href="/interview_blog/assets/js/34.b8c73cce.js"><link rel="prefetch" href="/interview_blog/assets/js/35.3e8d4f21.js"><link rel="prefetch" href="/interview_blog/assets/js/36.ed8a1bb7.js"><link rel="prefetch" href="/interview_blog/assets/js/37.ce354d46.js"><link rel="prefetch" href="/interview_blog/assets/js/38.37bcf5ce.js"><link rel="prefetch" href="/interview_blog/assets/js/39.d4956b62.js"><link rel="prefetch" href="/interview_blog/assets/js/4.87406268.js"><link rel="prefetch" href="/interview_blog/assets/js/40.f0ecd4dc.js"><link rel="prefetch" href="/interview_blog/assets/js/41.01c18d9c.js"><link rel="prefetch" href="/interview_blog/assets/js/42.f229993f.js"><link rel="prefetch" href="/interview_blog/assets/js/43.f08935e7.js"><link rel="prefetch" href="/interview_blog/assets/js/45.dbda6222.js"><link rel="prefetch" href="/interview_blog/assets/js/46.661000b0.js"><link rel="prefetch" href="/interview_blog/assets/js/47.12709f91.js"><link rel="prefetch" href="/interview_blog/assets/js/48.d8e794b9.js"><link rel="prefetch" href="/interview_blog/assets/js/5.c38690e3.js"><link rel="prefetch" href="/interview_blog/assets/js/6.f9104e5b.js"><link rel="prefetch" href="/interview_blog/assets/js/7.397ab168.js"><link rel="prefetch" href="/interview_blog/assets/js/8.3afdacb3.js"><link rel="prefetch" href="/interview_blog/assets/js/9.a12c6f31.js">
    <link rel="stylesheet" href="/interview_blog/assets/css/0.styles.81bffcaa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/interview_blog/" class="home-link router-link-active"><!----> <span class="site-name">blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview_blog/" class="nav-link">
  文章目录
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview_blog/" class="nav-link">
  文章目录
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/interview_blog/" aria-current="page" class="sidebar-link">JavaScript</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue3 UI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ajax &amp; jsonp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>webpack</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview_blog/webpackInfo/compile.html" class="sidebar-link">你用 webpack 做过什么优化吗？</a></li><li><a href="/interview_blog/webpackInfo/myWebpack.html" class="sidebar-link">打包原理</a></li><li><a href="/interview_blog/webpackInfo/babel.html" aria-current="page" class="active sidebar-link">AST、Babel、依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#先从-babel-说起" class="sidebar-link">先从 babel 说起</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#原理" class="sidebar-link">原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#代码示例" class="sidebar-link">代码示例</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#为什么必须要用-ast-为什么不用正则来替换" class="sidebar-link">为什么必须要用 AST，为什么不用正则来替换</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#能不能自动把代码转为-es5" class="sidebar-link">能不能自动把代码转为 ES5</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#不对-代码不应该是单独的文件吗" class="sidebar-link">不对，代码不应该是单独的文件吗？</a></li></ul></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#分析-index-js-的依赖" class="sidebar-link">分析 index.js 的依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#project1-deps-1-ts" class="sidebar-link">project1 &amp; deps_1.ts</a></li></ul></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#递归地分析嵌套依赖" class="sidebar-link">递归地分析嵌套依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#三层依赖关系" class="sidebar-link">三层依赖关系</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#启发-用递归来获取嵌套依赖" class="sidebar-link">启发：用递归来获取嵌套依赖</a></li></ul></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#静态分析循环依赖" class="sidebar-link">静态分析循环依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#依赖关系" class="sidebar-link">依赖关系</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#试着运行下代码" class="sidebar-link">试着运行下代码</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#你是说「不能循环依赖」吗" class="sidebar-link">你是说「不能循环依赖」吗？</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#避免重复进入同一循环" class="sidebar-link">避免重复进入同一循环</a></li></ul></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#结论" class="sidebar-link">结论</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/interview_blog/webpackInfo/babel.html#babel-和-babel-ployfill-的关系" class="sidebar-link">babel 和 babel ployfill 的关系</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>http</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>函数式编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SSR</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ast、babel、依赖"><a href="#ast、babel、依赖" class="header-anchor">#</a> AST、Babel、依赖</h1> <p><a href="https://github.com/Maricaya/my-babel-demo" target="_blank" rel="noopener noreferrer">地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="先从-babel-说起"><a href="#先从-babel-说起" class="header-anchor">#</a> 先从 babel 说起</h2> <p>把es6 代码转换成 es5代码</p> <h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <ol><li>parse 把代码 code 变成 AST</li> <li>traverse 遍历 AST 进行修改</li> <li>generate 把 AST 变成 code2
即 code -- 1 --&gt; AST -- 2 --&gt; ast2 -- 3 --&gt; code</li></ol> <h3 id="代码示例"><a href="#代码示例" class="header-anchor">#</a> 代码示例</h3> <p>手动把 let 变成 var</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@babel/parser&quot;</span>
<span class="token keyword">import</span> traverse <span class="token keyword">from</span> <span class="token string">&quot;@babel/traverse&quot;</span>
<span class="token keyword">import</span> generate <span class="token keyword">from</span> <span class="token string">&quot;@babel/generator&quot;</span>

<span class="token comment">// 1. parse 代码转换为 AST</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">let a = 'let'; let b = 2</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token operator">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 2. traverse 遍历</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">enter</span><span class="token operator">:</span> item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">===</span> <span class="token string">'VariableDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>node<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">'let'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span>node<span class="token punctuation">.</span>kind <span class="token operator">=</span> <span class="token string">'var'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 3. generate</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="为什么必须要用-ast-为什么不用正则来替换"><a href="#为什么必须要用-ast-为什么不用正则来替换" class="header-anchor">#</a> 为什么必须要用 AST，为什么不用正则来替换</h3> <ul><li>你很难用正则表达式来替换，正则很容易把 <code>let a = 'let'</code> 变成 <code>var a = 'var'</code></li> <li>你需要识别每个单词的意思，才能做到只修改用于声明变量的 let</li> <li>而 AST 能明确告诉你每个 let 的意思</li></ul> <h3 id="能不能自动把代码转为-es5"><a href="#能不能自动把代码转为-es5" class="header-anchor">#</a> 能不能自动把代码转为 ES5</h3> <p>可以，使用 <code>@babel/core</code> 和 <code>@babel/preset-env</code> 即可</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@babel/parser'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babel <span class="token keyword">from</span> <span class="token string">'@babel/core'</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">let a = 'let';let b = 2;const c = 3;</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token operator">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformFromAstSync</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="不对-代码不应该是单独的文件吗"><a href="#不对-代码不应该是单独的文件吗" class="header-anchor">#</a> 不对，代码不应该是单独的文件吗？</h3> <p>我们来改造一下代码</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@babel/parser'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babel <span class="token keyword">from</span> <span class="token string">'@babel/core'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./test.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token operator">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformFromAstSync</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'./test.es5.js'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>思考题：如何把 <code>./test.js</code> 变成任意文件呢</p> <h2 id="分析-index-js-的依赖"><a href="#分析-index-js-的依赖" class="header-anchor">#</a> 分析 index.js 的依赖</h2> <h3 id="project1-deps-1-ts"><a href="#project1-deps-1-ts" class="header-anchor">#</a> project1 &amp; deps_1.ts</h3> <ul><li><p>project1 有 3 个 JS 文件 <code>index.js/a.js/b.js</code></p></li> <li><p>依赖关系是 index -&gt; a/b</p></li></ul> <p>运行 <code>deps_1.ts</code> 得到结果</p> <div class="language-shell script line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">yarn</span> ts deps_1.ts     
<span class="token function">yarn</span> run v1.22.4
$ node -r ts-node/register deps_1.ts
<span class="token punctuation">{</span>
  <span class="token string">'index.js'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    deps: <span class="token punctuation">[</span> <span class="token string">'a.js'</span>, <span class="token string">'b.js'</span> <span class="token punctuation">]</span>,
    code: <span class="token string">'<span class="token entity" title="\n">\n</span>'</span> +
      <span class="token string">&quot;import a from './a.js'<span class="token entity" title="\n">\n</span>&quot;</span> +
      <span class="token string">&quot;import b from './b.js'<span class="token entity" title="\n">\n</span>&quot;</span> +
      <span class="token string">'console.log(a.value + b.value)<span class="token entity" title="\n">\n</span>'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="代码思路"><a href="#代码思路" class="header-anchor">#</a> 代码思路</h4> <ol><li>调用 collectCodeAndDeps('index.js')</li> <li>先把 depRelation['index.js'] 初始化为 { deps: [], code: 'index 的源码' }</li> <li>然后把 index.js 源码 code 变成 ast</li> <li>遍历 ast，看看 import 了哪些依赖，依赖了 a.js 和 b.js</li> <li>把 a.js 和 b.js 写到 depRelation['index.js'].deps 里</li> <li>最终得到的 depRelation 就收集了 index.js 的依赖</li></ol> <h4 id="启发-用哈希表来存储文件的依赖关系"><a href="#启发-用哈希表来存储文件的依赖关系" class="header-anchor">#</a> 启发：用哈希表来存储文件的依赖关系</h4> <p>*哈希表是数据结构中的术语，在 js 中一个对象就可以看作一个哈希表。
这是计数排序的基本操作</p> <h2 id="递归地分析嵌套依赖"><a href="#递归地分析嵌套依赖" class="header-anchor">#</a> 递归地分析嵌套依赖</h2> <h3 id="三层依赖关系"><a href="#三层依赖关系" class="header-anchor">#</a> 三层依赖关系</h3> <ul><li>index -&gt; a -&gt; dir/a2 -&gt; dir/dir_in_dir/a3</li> <li>index -&gt; b -&gt; dir/b2 -&gt; dir/dir_in_dir/b3</li> <li>文件在 project_2</li></ul> <h3 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h3> <ul><li>collectCodeAndDeps 太长了，改为 collect</li> <li>调用 collect('index.js')</li> <li>发现依赖 './a.js' 于是调用 collect('dir/a2.js')</li> <li>发现依赖 './dir_in_dir/a3.js' 于是调用 collect('dir/dir_in_dir/a3.js)</li> <li>没有更多依赖，a.js 这条线就结束，发现下一个依赖 './b.js'</li> <li>依次类推，其实就是递归</li></ul> <h3 id="启发-用递归来获取嵌套依赖"><a href="#启发-用递归来获取嵌套依赖" class="header-anchor">#</a> 启发：用递归来获取嵌套依赖</h3> <p>递归存在 call stack 溢出的风险，比如嵌套层数超过 20000 时，程序直接崩溃</p> <h2 id="静态分析循环依赖"><a href="#静态分析循环依赖" class="header-anchor">#</a> 静态分析循环依赖</h2> <p>再复杂一点：循环依赖 (project_3)</p> <h3 id="依赖关系"><a href="#依赖关系" class="header-anchor">#</a> 依赖关系</h3> <ul><li>index -&gt; a -&gt; b</li> <li>index -&gt; b -&gt; a</li></ul> <h4 id="求值"><a href="#求值" class="header-anchor">#</a> 求值</h4> <ul><li>a.value = b.value + 1</li> <li>b.value = a.value + 1</li></ul> <h3 id="试着运行下代码"><a href="#试着运行下代码" class="header-anchor">#</a> 试着运行下代码</h3> <ul><li>报错：调用栈 溢出了</li> <li>为什么：过程 a -&gt; b -&gt; a -&gt; b -&gt; a -&gt; b -&gt; a ... 把调用栈撑满了</li></ul> <h3 id="你是说「不能循环依赖」吗"><a href="#你是说「不能循环依赖」吗" class="header-anchor">#</a> 你是说「不能循环依赖」吗？</h3> <p>并不是这样，我们需要一些小技巧</p> <h3 id="避免重复进入同一循环"><a href="#避免重复进入同一循环" class="header-anchor">#</a> 避免重复进入同一循环</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">collectCodeAndDeps</span><span class="token punctuation">(</span>filepath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">getProjectPath</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span> <span class="token comment">// 文件的项目路径，如 index.js</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>depRelation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">duplicated dependency: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 注意，重复依赖不一定是循环依赖</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>一旦发现这个 key 已经在 keys 里了，就 return</li> <li>这样分析过程就不是 a -&gt; b -&gt; a -&gt; b -&gt; ... , 而是 a -&gt; b -&gt; return</li> <li>注意我们只需要<strong>分析依赖</strong>，不需要<strong>执行代码</strong>，所以这样分析是可行的</li> <li>由于我们的分析不需要执行代码，所以叫做<strong>静态分析</strong></li> <li>但如果我们<strong>执行代码</strong>，就会发现还是出现了循环</li></ul> <p>如果执行，还是会报错的</p> <blockquote><p>分析是分析，执行是执行</p></blockquote> <h2 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h2> <ul><li><p>模块间可以循环依赖</p> <ul><li>a依赖b，b依赖a</li> <li>a依赖b，b依赖c，c依赖a</li></ul></li> <li><p>但不能有逻辑绿皮的拍卖会</p> <ul><li>a.value = b.value+1</li> <li>b.value = a.value+1</li> <li>这种就不行</li></ul></li> <li><p>那你能不能写一个没有逻辑漏洞的循环依赖？</p> <ul><li>当然可以，继续看吧（project_5)</li> <li>有的循环依赖是有问题的，有的循环依赖是没有问题的</li> <li>所有最好别用循环依赖，以防万一</li></ul></li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li><p>AST 相关</p> <ol><li>parse 把代码 code 变成 AST</li> <li>traverse 遍历 AST 进行修改</li> <li>generate 把 AST 变成 code2</li></ol></li> <li><p>工具</p> <ol><li>babel 可以把高级代码翻译为 ES5</li> <li>@babel/parse</li> <li>@babel/traverse</li> <li>@babel/generate</li> <li>@babel/core 包含前三者</li> <li>@babel/preset-env 内置很多规则则</li></ol></li> <li><p>代码技巧</p> <ol><li>使用哈希表来存储数据</li> <li>通过检测 key 来避免重复</li></ol></li> <li><p>循环依赖</p> <ol><li>有的循环依赖可以正常执行</li> <li>有的循环依赖不可以</li> <li>但都可以做静态分析</li></ol> <h2 id="babel-和-babel-ployfill-的关系"><a href="#babel-和-babel-ployfill-的关系" class="header-anchor">#</a> babel 和 babel ployfill 的关系</h2> <div class="language- extra-class"><pre><code> 1、先来理解下 babel 到底是做什么的？
 
 简单来讲，babel解决语法层面的问题。用于将ES6+的高级语法转为ES5。
 
 2、babel polyfill 又是做什么的？
 
 如果要解决API层面的问题，需要使用垫片。比如常见的有babel-polyfill、babel-runtime 和 babel-plugin-transform-runtime。
</code></pre></div></li></ul> <h1 id="polyfill"><a href="#polyfill" class="header-anchor">#</a> polyfill</h1> <p>https://www.zhihu.com/question/49382420</p> <ul><li><p>Babel 是处于构建时（也就是传统Java等语言的编译时），「转换syntax层语法」</p></li> <li><p>转译出来的结果在默认情况下并不包括 ES6 对运行时的扩展，</p> <ul><li>builtins（内建，包括 Promise、Set、Map 等）</li> <li>内建类型上的原型扩展（如 ES6 对 Array、Object、String 等内建类型原型上的扩展）</li> <li>Regenerator（用于generators / yield）等都不包括在内。</li></ul></li></ul> <p>总结：
babel-runtime 库，
<code>polyfill</code>： 是看你的项目所需要的运行的浏览器环境决定的,不是必须的Babel只是转换syntax层语法,所有需要<code>@babel/ployfill</code> 来处理API兼容,又因为 <code>ployfill</code> 体积太大，</p> <p>所以通过 <code>preset</code> 的 useBuiltIns 来实现按需加载。</p> <p>再接着为了满足 npm 组件开发的需要 出现了 <code>@babel/runtime</code> 来做隔离。
<code>babel-plugin-transform-runtime</code></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/16/2020, 3:21:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview_blog/webpackInfo/myWebpack.html" class="prev">
        打包原理
      </a></span> <span class="next"><a href="/interview_blog/http/cache.html">
        HTTP 缓存有哪几种？
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/interview_blog/assets/js/app.6e789ca6.js" defer></script><script src="/interview_blog/assets/js/2.aedcd1eb.js" defer></script><script src="/interview_blog/assets/js/44.d134aed1.js" defer></script>
  </body>
</html>
