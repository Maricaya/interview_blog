<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="系统性学习，打造完善的知识体系">
    
    <link rel="preload" href="/interview_blog/assets/css/0.styles.81bffcaa.css" as="style"><link rel="preload" href="/interview_blog/assets/js/app.6e789ca6.js" as="script"><link rel="preload" href="/interview_blog/assets/js/2.aedcd1eb.js" as="script"><link rel="preload" href="/interview_blog/assets/js/48.d8e794b9.js" as="script"><link rel="prefetch" href="/interview_blog/assets/js/10.235d3cd2.js"><link rel="prefetch" href="/interview_blog/assets/js/11.64c88d1d.js"><link rel="prefetch" href="/interview_blog/assets/js/12.389e02a9.js"><link rel="prefetch" href="/interview_blog/assets/js/13.5fd0b99f.js"><link rel="prefetch" href="/interview_blog/assets/js/14.addbf244.js"><link rel="prefetch" href="/interview_blog/assets/js/15.aaa172ef.js"><link rel="prefetch" href="/interview_blog/assets/js/16.efde6c27.js"><link rel="prefetch" href="/interview_blog/assets/js/17.efe499ad.js"><link rel="prefetch" href="/interview_blog/assets/js/18.b43e2679.js"><link rel="prefetch" href="/interview_blog/assets/js/19.1e7d1f1d.js"><link rel="prefetch" href="/interview_blog/assets/js/20.61100763.js"><link rel="prefetch" href="/interview_blog/assets/js/21.77d90c63.js"><link rel="prefetch" href="/interview_blog/assets/js/22.f398ec5f.js"><link rel="prefetch" href="/interview_blog/assets/js/23.a0ed082a.js"><link rel="prefetch" href="/interview_blog/assets/js/24.a5e14725.js"><link rel="prefetch" href="/interview_blog/assets/js/25.dbe614ed.js"><link rel="prefetch" href="/interview_blog/assets/js/26.f2947465.js"><link rel="prefetch" href="/interview_blog/assets/js/27.ccd771c7.js"><link rel="prefetch" href="/interview_blog/assets/js/28.78bc3610.js"><link rel="prefetch" href="/interview_blog/assets/js/29.ad03d3fc.js"><link rel="prefetch" href="/interview_blog/assets/js/3.b709dd0d.js"><link rel="prefetch" href="/interview_blog/assets/js/30.12e12cb8.js"><link rel="prefetch" href="/interview_blog/assets/js/31.63b1cf5c.js"><link rel="prefetch" href="/interview_blog/assets/js/32.10ace32c.js"><link rel="prefetch" href="/interview_blog/assets/js/33.14d149d9.js"><link rel="prefetch" href="/interview_blog/assets/js/34.b8c73cce.js"><link rel="prefetch" href="/interview_blog/assets/js/35.3e8d4f21.js"><link rel="prefetch" href="/interview_blog/assets/js/36.ed8a1bb7.js"><link rel="prefetch" href="/interview_blog/assets/js/37.ce354d46.js"><link rel="prefetch" href="/interview_blog/assets/js/38.37bcf5ce.js"><link rel="prefetch" href="/interview_blog/assets/js/39.d4956b62.js"><link rel="prefetch" href="/interview_blog/assets/js/4.87406268.js"><link rel="prefetch" href="/interview_blog/assets/js/40.f0ecd4dc.js"><link rel="prefetch" href="/interview_blog/assets/js/41.01c18d9c.js"><link rel="prefetch" href="/interview_blog/assets/js/42.f229993f.js"><link rel="prefetch" href="/interview_blog/assets/js/43.f08935e7.js"><link rel="prefetch" href="/interview_blog/assets/js/44.d134aed1.js"><link rel="prefetch" href="/interview_blog/assets/js/45.dbda6222.js"><link rel="prefetch" href="/interview_blog/assets/js/46.661000b0.js"><link rel="prefetch" href="/interview_blog/assets/js/47.12709f91.js"><link rel="prefetch" href="/interview_blog/assets/js/5.c38690e3.js"><link rel="prefetch" href="/interview_blog/assets/js/6.f9104e5b.js"><link rel="prefetch" href="/interview_blog/assets/js/7.397ab168.js"><link rel="prefetch" href="/interview_blog/assets/js/8.3afdacb3.js"><link rel="prefetch" href="/interview_blog/assets/js/9.a12c6f31.js">
    <link rel="stylesheet" href="/interview_blog/assets/css/0.styles.81bffcaa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/interview_blog/" class="home-link router-link-active"><!----> <span class="site-name">blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview_blog/" class="nav-link">
  文章目录
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview_blog/" class="nav-link">
  文章目录
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/interview_blog/" aria-current="page" class="sidebar-link">JavaScript</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue3 UI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ajax &amp; jsonp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>http</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>函数式编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SSR</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="sidebardepth-3"><a href="#sidebardepth-3" class="header-anchor">#</a> `---
sidebarDepth: 3</h2> <h1 id="webpack-原理"><a href="#webpack-原理" class="header-anchor">#</a> webpack 原理</h1> <h2 id="怎样才能运行-import-export"><a href="#怎样才能运行-import-export" class="header-anchor">#</a> 怎样才能运行 import / export</h2> <ul><li><p>不同浏览器功能不同</p> <ul><li><p>现代浏览器可以通过 <code>&lt;script type=module&gt;</code> 来支持 import export</p></li> <li><p>IE 8~15 不支持 import export，</p></li></ul></li> <li><p>兼容策略</p> <ul><li><p>激进的兼容策略：把代码全放在 <code>&lt;script type=module&gt;</code> 里</p></li> <li><p>缺点：不被 IE 8~15 支持；而且会导致<strong>文件请求过多</strong>。</p></li> <li><p><strong>平稳的兼容策略</strong>：把 关键字<strong>转译</strong>为普通代码，并把所有文件打包成一个文件。</p> <ul><li><p>为什么不叫编译呢？</p> <ul><li><p>一般来说，编译是指把语言从高级的编译为低级的，或者是从C语言编向汇编。</p></li> <li><p>这块只是翻译为不同的代码形式，所以叫转译更加准确。</p></li></ul></li></ul></li> <li><p>缺点：需要写复杂的代码来完成这件事情，</p></li></ul></li></ul> <h2 id="解决第一个问题-怎么把-import-export-转成函数"><a href="#解决第一个问题-怎么把-import-export-转成函数" class="header-anchor">#</a> 解决第一个问题：怎么把 <code>import / export</code> 转成函数</h2> <p><code>@babel/core</code> 已经帮我们做了</p> <p>我们运行 <code>bundler_1.ts</code>，<code>a.js</code> 的变化</p> <ul><li>import 关键字不见了</li> <li>变成了 require()</li> <li>export 关键字不见了</li> <li>变成了 exports['default']</li></ul> <h2 id="a-js-变成-es5-之后的代码"><a href="#a-js-变成-es5-之后的代码" class="header-anchor">#</a> a.js 变成 ES5 之后的代码</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 疑惑 1</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>                                 <span class="token comment">// 疑惑 2</span>
<span class="token keyword">var</span> _b <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./b.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 细节 1</span>
<span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                       <span class="token comment">// 细节 1</span>
  <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span>   <span class="token comment">// 细节 1</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>  
  <span class="token function-variable function">getB</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">getB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _b<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">' from a.js'</span><span class="token punctuation">;</span>               <span class="token comment">// 细节 1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _default <span class="token operator">=</span> a<span class="token punctuation">;</span>                                            <span class="token comment">// 细节 2</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> _default<span class="token punctuation">;</span>                               <span class="token comment">// 细节 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="疑惑1-object-defineproperty-exports-esmodule-value-true"><a href="#疑惑1-object-defineproperty-exports-esmodule-value-true" class="header-anchor">#</a> 疑惑1： <code>Object.defineProperty(exports, &quot;__esModule&quot;, {value: true});</code></h3> <p>这是在做啥？</p> <ul><li><p>给当前模块添加 <code>__esModule: true</code> 属性，方便跟 <code>CommonJS</code> 模块区分开</p></li> <li><p>那为什么不直接用 <code>exports.__esModule = true</code> 非要装个逼？</p></li> <li><p>我看了下 <a href="https://github.com/babel/babel/blob/e498bee10f0123bb208baa228ce6417542a2c3c4/packages/babel-helper-module-transforms/src/index.js#L215" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，发现是可以通过选项来切换的</p></li> <li><p>所以两种区别不大，上面写法功能更强，exports.__esModule 兼容性更好</p></li></ul> <h3 id="疑惑2-exports-default-void-0"><a href="#疑惑2-exports-default-void-0" class="header-anchor">#</a> 疑惑2：exports[&quot;default&quot;] = void 0;</h3> <p>这是在做啥？</p> <ul><li><p>void 0 等价于 undefined，老 JSer 的常见过时技巧</p></li> <li><p>这句话是为了强制清空 <code>exports['default']</code> 的值</p></li> <li><p>为什么要清空？我也不知道，我感觉没有必要，可能有些特殊情况我没想到吧</p></li></ul> <h3 id="转译的细节-1-import-b-from-b-js-变成了-var-b-interoprequiredefault-require-b-js-b-value-变成了-b-default-value"><a href="#转译的细节-1-import-b-from-b-js-变成了-var-b-interoprequiredefault-require-b-js-b-value-变成了-b-default-value" class="header-anchor">#</a> 转译的细节 1:<code>import b from './b.js'</code> 变成了,<code>var _b = _interopRequireDefault(require(&quot;./b.js&quot;));</code> <code>b.value</code> 变成了 <code>_b['default'].value</code></h3> <ul><li>解释 <code>_interopRequireDefault(module)</code> :<code>_</code> 下划线前缀是为了避免与其他变量重名</li> <li>该函数的意图是给模块添加 'default'</li> <li>为什么要加 default：CommonJS 模块没有默认导出，加上方便兼容</li> <li>内部实现：return m &amp;&amp; m.__esModule ? m : { &quot;default&quot;: m }</li> <li>其他 _interop 开头的函数大多都是为了兼容旧代码</li></ul> <h3 id="转译的细节2-export-default-a-变成了-var-default-a-exports-default-default-简化一下就是-exports-default-a"><a href="#转译的细节2-export-default-a-变成了-var-default-a-exports-default-default-简化一下就是-exports-default-a" class="header-anchor">#</a> 转译的细节2：<code>export default a</code> 变成了:<code>var _default = a; exports[&quot;default&quot;] = _default;</code> 简化一下就是 <code>exports[&quot;default&quot;] = a</code></h3> <p><code>const x = 'x'; export {x}</code> 会变成
<code>var x = 'x'; exports.x = x</code>
解释</p> <ul><li>这个 <code>_default</code> 中间变量有什么意义我也没看出来，也许后面有用</li> <li>其他部分都挺好理解的</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><code>import</code> 关键字会变成 <code>require</code> 函数，<code>export</code> 关键字会变成 <code>exports</code> 对象</p> <ul><li><p>本质：<code>ESModule</code> 语法变成了 <code>CommonJS</code> 规则</p></li> <li><p>但目前我们不知道 <code>require</code> 函数怎么写，先不管，假设 <code>require</code> 已经写好了</p></li></ul> <h2 id="把多个文件打包成一个"><a href="#把多个文件打包成一个" class="header-anchor">#</a> 把多个文件打包成一个</h2> <h3 id="打包成一个什么样的文件"><a href="#打包成一个什么样的文件" class="header-anchor">#</a> 打包成一个什么样的文件</h3> <p>肯定<strong>包含</strong>了所有模块，然后能<strong>执行</strong>所有模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> depRelation <span class="token operator">=</span> <span class="token punctuation">[</span> 
  <span class="token punctuation">{</span>key<span class="token operator">:</span> <span class="token string">'index.js'</span><span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'a.js'</span><span class="token punctuation">,</span> <span class="token string">'b.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function-variable function">code</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>key<span class="token operator">:</span> <span class="token string">'a.js'</span><span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'b.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function-variable function">code</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>key<span class="token operator">:</span> <span class="token string">'b.js'</span><span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'a.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function-variable function">code</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span> <span class="token comment">// 为什么把 depRelation 从对象改为数组？</span>
<span class="token comment">// 因为数组的第一项就是入口，而对象没有第一项的概念</span>
<span class="token function">execute</span><span class="token punctuation">(</span>depRelation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token comment">// 执行入口文件</span>
<span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> item <span class="token operator">=</span> depRelation<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span>
  item<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token string">'???'</span><span class="token punctuation">)</span> <span class="token comment">// 执行 item 的代码，因此 code 最好是个函数，方便执行</span>
  <span class="token comment">// 但是目前还不知道要传什么参数给 code </span>
  <span class="token comment">// 代码待完善</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>现在有三个问题还没解决</p> <ol><li><code>depRelation</code> 是对象，需要变成一个数组</li> <li><code>code</code> 是字符串，需要变成一个函数</li> <li><code>execute</code> 函数待完善</li></ol> <h3 id="_1-把-deprelation-改为一个数组"><a href="#_1-把-deprelation-改为一个数组" class="header-anchor">#</a> 1. 把 <code>depRelation</code> 改为一个数组</h3> <p>代码在 <code>bundler_2.ts</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>depRelation<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code<span class="token operator">:</span> es5Code <span class="token punctuation">}</span>
<span class="token comment">// 改为了</span>
<span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code<span class="token operator">:</span> es5Code <span class="token punctuation">}</span>
depRelation<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>想知道所有的改动？把 bundler_1.ts 与 bundler_2.ts 对比即可</p> <h3 id="_2-把-code-由字符串改为函数"><a href="#_2-把-code-由字符串改为函数" class="header-anchor">#</a> 2. 把 code 由字符串改为函数</h3> <ol><li><p>步骤
在 code 字符串外面包一个 <code>function(require, module, exports){ ... } *</code>（这是 CommonJS 2 的规定）
把 code 写到文件里，引号不会出现在文件中</p></li> <li><p>举例</p></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  var b = require('./b.js')
  exports.default = 'a'
</span><span class="token template-punctuation string">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>code2 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> function(require, module, exports){
   </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
 }</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// 注意此时 code2 还是字符串</span>

<span class="token comment">// 然后把 `{code: ${code2}}` 写入最终文件里</span>
<span class="token comment">// 最终文件里的 code 就是函数了</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="完善-execute-函数-主体思路"><a href="#完善-execute-函数-主体思路" class="header-anchor">#</a> 完善 execute 函数 （主体思路）</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// modules 用于缓存所有模块 function execute(key) { </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modules<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> modules<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token keyword">var</span> item <span class="token operator">=</span> depRelation<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span>
  <span class="token keyword">var</span> <span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">pathToKey</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  modules<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> __esModule<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token comment">// modules['a.js']</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> exports<span class="token operator">:</span> modules<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token punctuation">}</span>
  item<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> 
  <span class="token keyword">return</span> modules<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="最终文件主要内容"><a href="#最终文件主要内容" class="header-anchor">#</a> 最终文件主要内容</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> depRelation <span class="token operator">=</span> <span class="token punctuation">[</span> 
  <span class="token punctuation">{</span>key<span class="token operator">:</span> <span class="token string">'index.js'</span><span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'a.js'</span><span class="token punctuation">,</span> <span class="token string">'b.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function-variable function">code</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>key<span class="token operator">:</span> <span class="token string">'a.js'</span><span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'b.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function-variable function">code</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>key<span class="token operator">:</span> <span class="token string">'b.js'</span><span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'a.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function-variable function">code</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span> 
<span class="token keyword">var</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// modules 用于缓存所有模块</span>
<span class="token function">execute</span><span class="token punctuation">(</span>depRelation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> require <span class="token operator">=</span> <span class="token operator">...</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token operator">...</span>
  item<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// 详见 dist.js</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="怎么得到最终文件呢"><a href="#怎么得到最终文件呢" class="header-anchor">#</a> 怎么得到最终文件呢？</h2> <p>答案很简单：拼凑出字符串，然后写入文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> dist <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
dist <span class="token operator">+=</span> content<span class="token punctuation">;</span> 
<span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'dist.js'</span><span class="token punctuation">,</span> dist<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/20/2020, 5:16:06 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/interview_blog/assets/js/app.6e789ca6.js" defer></script><script src="/interview_blog/assets/js/2.aedcd1eb.js" defer></script><script src="/interview_blog/assets/js/48.d8e794b9.js" defer></script>
  </body>
</html>
